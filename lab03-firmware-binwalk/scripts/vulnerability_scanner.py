#!/usr/bin/env python3
"""
Advanced Firmware Vulnerability Scanner
"""

import os
import re
import json
from pathlib import Path


class VulnerabilityScanner:
    def __init__(self, extracted_dir):
        self.extracted_dir = Path(extracted_dir)
        self.vulnerabilities = []

    # -------------------------------------------------
    # 1Ô∏è‚É£ Command Injection Scan
    # -------------------------------------------------
    def scan_command_injection(self):
        """Scan for command injection vulnerabilities"""
        print("[+] Scanning for command injection vulnerabilities...")

        dangerous_functions = [
            r'system\s*\(',
            r'exec\s*\(',
            r'popen\s*\(',
            r'shell_exec\s*\(',
            r'passthru\s*\(',
            r'eval\s*\('
        ]

        for file_path in self.extracted_dir.rglob("*"):
            if file_path.is_file() and file_path.suffix in ['.php', '.c', '.cpp', '.sh', '.py']:
                try:
                    with open(file_path, 'r', encoding='utf-8', errors='ignore') as f:
                        content = f.read()

                    for pattern in dangerous_functions:
                        matches = re.finditer(pattern, content, re.IGNORECASE)
                        for match in matches:
                            self.vulnerabilities.append({
                                'type': 'Command Injection',
                                'file': str(file_path),
                                'pattern': pattern,
                                'line': content[:match.start()].count('\n') + 1,
                                'severity': 'High'
                            })

                except Exception:
                    continue

    # -------------------------------------------------
    # 2Ô∏è‚É£ Hardcoded Credentials Scan
    # -------------------------------------------------
    def scan_hardcoded_credentials(self):
        """Scan for hardcoded credentials"""
        print("[+] Scanning for hardcoded credentials...")

        credential_patterns = [
            r'password\s*=\s*["\'][^"\']{3,}["\']',
            r'passwd\s*=\s*["\'][^"\']{3,}["\']',
            r'secret\s*=\s*["\'][^"\']{8,}["\']',
            r'api_key\s*=\s*["\'][^"\']{10,}["\']',
            r'private_key\s*=\s*["\'][^"\']{20,}["\']'
        ]

        for file_path in self.extracted_dir.rglob("*"):
            if file_path.is_file():
                try:
                    with open(file_path, 'r', encoding='utf-8', errors='ignore') as f:
                        content = f.read()

                    for pattern in credential_patterns:
                        matches = re.finditer(pattern, content, re.IGNORECASE)
                        for match in matches:
                            self.vulnerabilities.append({
                                'type': 'Hardcoded Credentials',
                                'file': str(file_path),
                                'pattern': pattern,
                                'line': content[:match.start()].count('\n') + 1,
                                'severity': 'Critical'
                            })

                except Exception:
                    continue

    # -------------------------------------------------
    # 3Ô∏è‚É£ Weak Cryptography Scan
    # -------------------------------------------------
    def scan_weak_crypto(self):
        """Scan for weak cryptographic implementations"""
        print("[+] Scanning for weak cryptographic implementations...")

        weak_crypto_patterns = [
            r'md5\s*\(',
            r'sha1\s*\(',
            r'des\s*\(',
            r'rc4\s*\(',
            r'rand\s*\(\)',
            r'srand\s*\('
        ]

        for file_path in self.extracted_dir.rglob("*"):
            if file_path.is_file() and file_path.suffix in ['.c', '.cpp', '.php', '.py', '.js']:
                try:
                    with open(file_path, 'r', encoding='utf-8', errors='ignore') as f:
                        content = f.read()

                    for pattern in weak_crypto_patterns:
                        matches = re.finditer(pattern, content, re.IGNORECASE)
                        for match in matches:
                            self.vulnerabilities.append({
                                'type': 'Weak Cryptography',
                                'file': str(file_path),
                                'pattern': pattern,
                                'line': content[:match.start()].count('\n') + 1,
                                'severity': 'Medium'
                            })

                except Exception:
                    continue

    # -------------------------------------------------
    # 4Ô∏è‚É£ File Permission Scan
    # -------------------------------------------------
    def scan_file_permissions(self):
        """Scan for insecure file permissions"""
        print("[+] Scanning for insecure file permissions...")

        for file_path in self.extracted_dir.rglob("*"):
            if file_path.is_file():
                try:
                    stat_info = file_path.stat()
                    mode = oct(stat_info.st_mode)[-3:]

                    # Check world-writable or overly permissive modes
                    if mode.endswith('2') or mode.endswith('6') or mode.endswith('7'):
                        self.vulnerabilities.append({
                            'type': 'Insecure File Permissions',
                            'file': str(file_path),
                            'permissions': mode,
                            'severity': 'Medium'
                        })

                except Exception:
                    continue

    # -------------------------------------------------
    # üìä Report Generation
    # -------------------------------------------------
    def generate_vulnerability_report(self):
        """Generate vulnerability report"""
        report = {
            'total_vulnerabilities': len(self.vulnerabilities),
            'critical': len([v for v in self.vulnerabilities if v.get('severity') == 'Critical']),
            'high': len([v for v in self.vulnerabilities if v.get('severity') == 'High']),
            'medium': len([v for v in self.vulnerabilities if v.get('severity') == 'Medium']),
            'vulnerabilities': self.vulnerabilities
        }

        report_file = self.extracted_dir.parent / "vulnerability_report.json"

        with open(report_file, 'w') as f:
            json.dump(report, f, indent=2)

        print(f"\n[+] Vulnerability report saved to: {report_file}")
        return report

    def print_vulnerability_summary(self, report):
        """Print vulnerability summary"""
        print("\n" + "=" * 30)
        print("VULNERABILITY SUMMARY")
        print("=" * 30)
        print(f"Total vulnerabilities found: {report['total_vulnerabilities']}")
        print(f"Critical: {report['critical']}")
        print(f"High: {report['high']}")
        print(f"Medium: {report['medium']}")

        if report['vulnerabilities']:
            print("\nTop 5 vulnerabilities:")
            for i, vuln in enumerate(report['vulnerabilities'][:5], 1):
                print(f"{i}. {vuln['type']} in {Path(vuln['file']).name} (Severity: {vuln['severity']})")

    # -------------------------------------------------
    # üöÄ Run Full Scan
    # -------------------------------------------------
    def run_full_scan(self):
        print("=" * 50)
        print("FIRMWARE VULNERABILITY SCAN")
        print("=" * 50)

        scan_methods = [
            self.scan_command_injection,
            self.scan_hardcoded_credentials,
            self.scan_weak_crypto,
            self.scan_file_permissions
        ]

        for scan_method in scan_methods:
            scan_method()

        report = self.generate_vulnerability_report()
        self.print_vulnerability_summary(report)

        return report


def main():
    import sys

    if len(sys.argv) != 2:
        print("Usage: python3 vulnerability_scanner.py <extracted_directory>")
        sys.exit(1)

    extracted_dir = sys.argv[1]

    if not os.path.exists(extracted_dir):
        print(f"Error: Directory '{extracted_dir}' not found")
        sys.exit(1)

    scanner = VulnerabilityScanner(extracted_dir)
    scanner.run_full_scan()


if __name__ == "__main__":
    main()
